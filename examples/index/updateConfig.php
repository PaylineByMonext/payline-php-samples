<?php
$update_config_status = 0;
if(isset($_POST['submit'])){
	$configFile = '../../lib/CONFIG.php';
	$nextLine = "\n";
	if(is_writable($configFile)){
		$handle = fopen($configFile, 'w');
		fwrite($handle, '<?php'.$nextLine.$nextLine);
		$timezone = "Europe/Paris";
		date_default_timezone_set($timezone);
		fwrite($handle, '// generated by updateConfig.php on '.date('d/m/Y H:i').'('.$timezone.' time)'.$nextLine.$nextLine);
		fwrite($handle, 'require_once realpath(dirname(dirname(__FILE__))).\'/vendor/autoload.php\';'.$nextLine);
		fwrite($handle, 'use Monolog\Logger;'.$nextLine);
		fwrite($handle, 'if (! isset($_SESSION)) session_start();'.$nextLine.$nextLine);
		
		fwrite($handle, '// global setting'.$nextLine);
		fwrite($handle, '$_SESSION[\'ENVIRONMENT\'] = \''.$_POST['ENVIRONMENT'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'MERCHANT_ID\'] = \''.trim($_POST['MERCHANT_ID']).'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'MERCHANT_NAME\'] = "'.$_POST['MERCHANT_NAME'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'ACCESS_KEY\'] = \''.trim($_POST['ACCESS_KEY']).'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'ACCESS_KEY_REF\'] = \''.trim($_POST['ACCESS_KEY_REF']).'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'WS_VERSION\'] = \''.$_POST['WS_VERSION'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'PROXY_HOST\'] = \''.trim($_POST['PROXY_HOST']).'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'PROXY_PORT\'] = \''.trim($_POST['PROXY_PORT']).'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'PROXY_LOGIN\'] = \''.trim($_POST['PROXY_LOGIN']).'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'PROXY_PASSWORD\'] = \''.trim($_POST['PROXY_PASSWORD']).'\';'.$nextLine);
		fwrite($handle, $nextLine.'// demo settings'.$nextLine);
		$parsedUrl = parse_url($_SERVER['HTTP_REFERER']);
		$parsedPath = explode('examples', $parsedUrl['path']);
		$kitRoot = $parsedUrl['scheme'].'://'.$parsedUrl['host'].$parsedPath[0];
		fwrite($handle, '$_SESSION[\'KIT_ROOT\'] = \''.$kitRoot.'\';'.$nextLine);
		$logPath = realpath(dirname(dirname(dirname(__FILE__)))) . DIRECTORY_SEPARATOR . 'logs' . DIRECTORY_SEPARATOR;
		$logPath = str_replace('\\', '\\\\', $logPath);
		fwrite($handle, '$_SESSION[\'LOG_PATH\'] = \''.$logPath.'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'LOG_LEVEL\'] = '.$_POST['LOG_LEVEL'].';'.$nextLine);
		
		fwrite($handle, $nextLine.'// payment setting'.$nextLine);
		fwrite($handle, '$_SESSION[\'PAYMENT_CURRENCY\'] = \''.$_POST['PAYMENT_CURRENCY'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'ORDER_CURRENCY\'] = \''.$_POST['ORDER_CURRENCY'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'LANGUAGE_CODE\'] = \''.$_POST['LANGUAGE_CODE'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'PAYMENT_ACTION\'] = \''.$_POST['PAYMENT_ACTION'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'PAYMENT_MODE\'] = \''.$_POST['PAYMENT_MODE'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'CUSTOM_PAYMENT_TEMPLATE_URL\'] = \''.$_POST['CUSTOM_PAYMENT_TEMPLATE_URL'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'CUSTOM_PAYMENT_PAGE_CODE\'] = \''.$_POST['CUSTOM_PAYMENT_PAGE_CODE'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'CONTRACT_NUMBER\'] = \''.$_POST['CONTRACT_NUMBER'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'CONTRACT_NUMBER_LIST\'] = \''.$_POST['CONTRACT_NUMBER_LIST'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'SECOND_CONTRACT_NUMBER_LIST\'] = \''.$_POST['SECOND_CONTRACT_NUMBER_LIST'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'WALLET_CONTRACT_NUMBER_LIST\'] = \''.$_POST['WALLET_CONTRACT_NUMBER_LIST'].'\';'.$nextLine);
		if($_POST['returnURL'] == ''){
		    fwrite($handle, '$_SESSION[\'RETURN_URL\'] = \''.$kitRoot.'examples/demos/web.php?e=getWebPaymentDetails'.'\';'.$nextLine);
		}else{
		    fwrite($handle, '$_SESSION[\'RETURN_URL\'] = \''.$_POST['returnURL'].'\';'.$nextLine);
		}
		fwrite($handle, '$_SESSION[\'NOTIFICATION_URL\'] = \''.$_POST['notificationURL'].'\';'.$nextLine);
		if($_POST['cancelURL'] == ''){
		    fwrite($handle, '$_SESSION[\'CANCEL_URL\'] = \''.$kitRoot.'examples/demos/web.php?e=getWebPaymentDetails'.'\';'.$nextLine);
		}else{
		    fwrite($handle, '$_SESSION[\'CANCEL_URL\'] = \''.$_POST['cancelURL'].'\';'.$nextLine);
		}
		
		
		fwrite($handle, $nextLine.'// buyer info'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerLegalStatus\'] = \''.$_POST['buyerLegalStatus'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerTitle\'] = \''.$_POST['buyerTitle'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerLastName\'] = "'.$_POST['buyerLastName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerFirstName\'] = "'.$_POST['buyerFirstName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerEmail\'] = \''.$_POST['buyerEmail'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressTitle\'] = "'.$_POST['billingAddressTitle'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressFirstName\'] = "'.$_POST['billingAddressFirstName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressLastName\'] = "'.$_POST['billingAddressLastName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressName\'] = "'.$_POST['billingAddressName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressStreet1\'] = "'.$_POST['billingAddressStreet1'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressStreet2\'] = "'.$_POST['billingAddressStreet2'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressCity\'] = "'.$_POST['billingAddressCity'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressZipCode\'] = \''.$_POST['billingAddressZipCode'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressCountry\'] = "'.$_POST['billingAddressCountry'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressCounty\'] = "'.$_POST['billingAddressCounty'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressState\'] = "'.$_POST['billingAddressState'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressPhoneType\'] = \''.$_POST['billingAddressPhoneType'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'billingAddressPhone\'] = \''.$_POST['billingAddressPhone'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressTitle\'] = \''.$_POST['shippingAddressTitle'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressFirstName\'] = "'.$_POST['shippingAddressFirstName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressLastName\'] = "'.$_POST['shippingAddressLastName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressName\'] = "'.$_POST['shippingAddressName'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressStreet1\'] = "'.$_POST['shippingAddressStreet1'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressStreet2\'] = "'.$_POST['shippingAddressStreet2'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressCity\'] = "'.$_POST['shippingAddressCity'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressZipCode\'] = \''.$_POST['shippingAddressZipCode'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressCountry\'] = "'.$_POST['shippingAddressCountry'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressCounty\'] = "'.$_POST['shippingAddressCounty'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressState\'] = "'.$_POST['shippingAddressState'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressPhoneType\'] = \''.$_POST['shippingAddressPhoneType'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'shippingAddressPhone\'] = \''.$_POST['shippingAddressPhone'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerAccountCreateDate\'] = \''.$_POST['buyerAccountCreateDate'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerAverageAmount\'] = \''.$_POST['buyerAverageAmount'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerOrderCount\'] = \''.$_POST['buyerOrderCount'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerWalletId\'] = "'.$_POST['buyerWalletId'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerWalletDisplayed\'] = \''.$_POST['buyerWalletDisplayed'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerWalletSecured\'] = \''.$_POST['buyerWalletSecured'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerWalletCardInd\'] = \''.$_POST['buyerWalletCardInd'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'buyerIp\'] = \''.$_POST['buyerIp'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'mobilePhone\'] = \''.$_POST['mobilePhone'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'customerId\'] = "'.$_POST['customerId'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'legalDocument\'] = \''.$_POST['legalDocument'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'birthDate\'] = \''.$_POST['birthDate'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'fingerprintID\'] = "'.$_POST['fingerprintID'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'deviceFingerprint\'] = "'.$_POST['deviceFingerprint'].'";'.$nextLine);
		fwrite($handle, '$_SESSION[\'isIncognito\'] = \''.$_POST['isIncognito'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'isBot\'] = \''.$_POST['isBot'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'isBehindProxy\'] = \''.$_POST['isBehindProxy'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'isFromTor\'] = \''.$_POST['isFromTor'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'isEmulator\'] = \''.$_POST['isEmulator'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'isRooted\'] = \''.$_POST['isRooted'].'\';'.$nextLine);
		fwrite($handle, '$_SESSION[\'hasTimezoneMismatch\'] = \''.$_POST['hasTimezoneMismatch'].'\';'.$nextLine);

		fwrite($handle, "?> \n");
		fclose($handle);
		$update_config_status = 0;
	}else{
		$update_config_status = 3;
	}
	header("Location: ../demos/index.php?e=configuration&res_upd=$update_config_status");
}else{
	header("Location: ../demos/index.php?e=configuration");
}
?>